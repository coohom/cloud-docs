<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Semantic Segmentation - MINERVAS Help Document</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../dsl.html"><strong aria-hidden="true">2.</strong> DSL Programing Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../scene_processor.html"><strong aria-hidden="true">2.1.</strong> Scene Processor</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../room.html"><strong aria-hidden="true">2.1.1.</strong> Room</a></li><li class="chapter-item expanded "><a href="../level.html"><strong aria-hidden="true">2.1.2.</strong> Level</a></li></ol></li><li class="chapter-item expanded "><a href="../entity_processor.html"><strong aria-hidden="true">2.2.</strong> Entity Processor</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dsl/camera.html"><strong aria-hidden="true">2.2.1.</strong> Camera</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dsl/perspective_camera.html"><strong aria-hidden="true">2.2.1.1.</strong> PerspectiveCamera</a></li><li class="chapter-item expanded "><a href="../dsl/orthographic_camera.html"><strong aria-hidden="true">2.2.1.2.</strong> OrthographicCamera</a></li><li class="chapter-item expanded "><a href="../dsl/panoramic_camera.html"><strong aria-hidden="true">2.2.1.3.</strong> PanoramicCamera</a></li></ol></li><li class="chapter-item expanded "><a href="../dsl/light.html"><strong aria-hidden="true">2.2.2.</strong> Light</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dsl/point_light.html"><strong aria-hidden="true">2.2.2.1.</strong> PointLight</a></li><li class="chapter-item expanded "><a href="../dsl/rectangle_light.html"><strong aria-hidden="true">2.2.2.2.</strong> RectangleLight</a></li><li class="chapter-item expanded "><a href="../dsl/sun_light.html"><strong aria-hidden="true">2.2.2.3.</strong> Sunlight</a></li><li class="chapter-item expanded "><a href="../dsl/iesspot_light.html"><strong aria-hidden="true">2.2.2.4.</strong> IESspotLight</a></li></ol></li><li class="chapter-item expanded "><a href="../dsl/instance.html"><strong aria-hidden="true">2.2.3.</strong> Instance</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dsl/material.html"><strong aria-hidden="true">2.2.3.1.</strong> Material</a></li><li class="chapter-item expanded "><a href="../dsl/mesh.html"><strong aria-hidden="true">2.2.3.2.</strong> Model</a></li></ol></li><li class="chapter-item expanded "><a href="../dsl/trajectory.html"><strong aria-hidden="true">2.2.4.</strong> Trajectory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dsl/random_trajectory.html"><strong aria-hidden="true">2.2.4.1.</strong> RandomTrajectory</a></li><li class="chapter-item expanded "><a href="../dsl/converage_trajectory.html"><strong aria-hidden="true">2.2.4.2.</strong> CoverageTrajectory</a></li><li class="chapter-item expanded "><a href="../dsl/defined_trajectory.html"><strong aria-hidden="true">2.2.4.3.</strong> DefinedTrajectory</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../render_processor.html"><strong aria-hidden="true">2.3.</strong> Render Processor</a></li><li class="chapter-item expanded "><a href="../pixel_processor.html"><strong aria-hidden="true">2.4.</strong> Pixel Processor</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dsl/pixel_process/output_selection.html"><strong aria-hidden="true">2.4.1.</strong> Output Selection</a></li><li class="chapter-item expanded "><a href="../dsl/pixel_process/noise.html"><strong aria-hidden="true">2.4.2.</strong> Noise Simulation</a></li><li class="chapter-item expanded "><a href="../dsl/pixel_process/distortion.html"><strong aria-hidden="true">2.4.3.</strong> Distortion Simulation</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../examples.html"><strong aria-hidden="true">3.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/layout_estimation.html"><strong aria-hidden="true">3.1.</strong> Layout Estimation</a></li><li class="chapter-item expanded "><a href="../examples/semantic_segmentation.html" class="active"><strong aria-hidden="true">3.2.</strong> Semantic Segmentation</a></li><li class="chapter-item expanded "><a href="../examples/depth_estimation.html"><strong aria-hidden="true">3.3.</strong> Depth Estimation</a></li><li class="chapter-item expanded "><a href="../examples/trajectory_sampling.html"><strong aria-hidden="true">3.4.</strong> SLAM</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">MINERVAS Help Document</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#semantic-segmentation" id="semantic-segmentation">Semantic Segmentation</a></h1>
<h2><a class="header" href="#introduction" id="introduction">Introduction</a></h2>
<p>Depth estimiation is an essential task in indoor scene understanding. We show the performance gain by generating dataset using our system.</p>
<p>Here we show the DSL for generating semantic mask in NYUd-v2-40 format which helps boosting the current semantic segmentation task.</p>
<p>More details can be found in the <a href="https://arxiv.org/pdf/2107.06149.pdf">paper</a> and <a href="https://drive.google.com/file/d/1avGTr44sGrWx_jWiNYEIrp3R7jbNPOgj/view">supplementary document</a>.</p>
<h2><a class="header" href="#dsl-code" id="dsl-code">DSL code</a></h2>
<!-- For room layout estimation task, we create a
filter rule using DSL in the Scene Process Stage, and setting
the type of camera as “panorama”. We also use the sampler
of the transform component to randomly move cameras, and
use the output component to write out corner positions and
camera parameters. -->
<p>In this example, we generate semantic labels and show the domain randomization ability of the MINERVAS system.</p>
<p>First, in the Entity Process Stage we filter out cameras in the rooms which do not has more than 4 furniture using <code>CameraFilter</code>. 
For each camera, we set the camera model as <code>panorama</code> and the resolution of the image to 640 * 480 in class <code>CameraSetting</code>. </p>
<p>We then utilize the system's ability for domain randomization to generate data. Specifically, we randomize room layout in the Scene Process Stage using <code>FurnitureLayoutSampler</code>. Then, we randomize material, model and camera in the Entity Process Stage using <code>EntityRandomizer</code>. </p>
<p>In the Pixel Process Stage, we generate semantic label with NYUv2 40 label set as shown in <code>SemanticOutput</code> class.</p>
<pre><code class="language-python">from ksecs.ECS.processors.entity_processor import EntityProcessor
from shapely.geometry import Point
class CameraFilter(EntityProcessor):
    def is_valid_room(self, room, num_furniture=3):
        # Check if the number of furniture in the room is above threshold.
        polygon = room.gen_polygon()
        count = 0
        for ins in self.shader.world.instances:
            if not ins.type == 'ASSET':
                continue
            if polygon.contains(Point([ins.transform[i] for i in [3, 7, 11]])):
                count += 1
        return count &gt; num_furniture
    
    def delete_cameras_in_room(self, room):
        polygon = room.gen_polygon()
        for camera in self.shader.world.cameras:
            if polygon.contains(Point([camera.position[axis] for axis in &quot;xyz&quot;])):
                self.shader.world.delete_entity(camera)

    def process(self):
        # We only use rooms with more than 4 assets
        for room in self.shader.world.rooms:
            if not self.is_valid_room(room, 4):
                self.delete_cameras_in_room(room)

class CameraSetting(EntityProcessor):
    def process(self):
        for camera in self.shader.world.cameras:
            camera.set_attr(&quot;imageWidth&quot;, 1024)
            camera.set_attr(&quot;imageHeight&quot;, 512)
            camera.set_attr(&quot;cameraType&quot;, &quot;PANORAMA&quot;)

# Randomize layout
from ksecs.ECS.processors.scene_processor import SceneProcessor
class FurnitureLayoutSampler(SceneProcessor):
    def process(self):
        for room in self.shader.world.rooms:
            room.randomize_layout(self.shader.world)

import numpy as np
class EntityRandomizer(EntityProcessor):
    def randomize_model_material(self):
        for instance in self.shader.world.instances:
            # Randomize material
            self.shader.world.replace_material(
                id=instance.id,
                type='REPLACE_ALL'
            )
            if instance.type == 'ASSET':
                # Randomize model
                self.shader.world.replace_model(
                    id=instance.id
                )

    def randomize_light(self):
        for light in self.shader.world.lights:
            # Randonly adjust the color temperature
            light._tune_temp(1)
            # Randomly adjust the light intensity
            light.tune_random(1.2)

    def randomize_camera(self):
        for camera in self.shader.world.cameras:
            random_vec = np.random.normal(0, 1, size=3)
            camera_pos = np.array(list(camera.position.values()))
            randomized_pos = camera_pos + random_vec * np.array([500.0, 500.0, 100.0])
            camera.set_attr('position', x=randomized_pos[0], y=randomized_pos[1], z=randomized_pos[2])
            camera.set_attr('lookAt', z=randomized_pos[2])

    def process(self):
        self.randomize_model_material()
        self.randomize_light()
        self.randomize_camera()

from ksecs.ECS.processors.render_processor import RenderProcessor
class Render(RenderProcessor):
    def process(self, *args, **kwargs):
        self.gen_rgb(distort=0, noise=0)

from ksecs.ECS.processors.pixel_processor import PixelProcessor
from ksecs.resources import NYU40_MAPPING
class SemanticOutput(PixelProcessor):
    def process(self, **kwargs):
        self.gen_semantic(label_arch=NYU40_MAPPING)
</code></pre>
<!-- First, we import some necessary packages.
```python
from ksecs.ECS.processors.pixel_processor import PixelProcessor
from ksecs.ECS.processors.entity_processor import EntityProcessor
```

For the semantic segmentation task, we set the type of camera to panorama in the Entity Process Stage, and output the semantic label image in the Pixel Process Stage.
We also map our semantic label to the NYUv2 40 label set using our DSL.

```python
class CameraSetting(EntityProcessor):
    def process(self):
        for camera in self.shader.world.cameras:
            camera.set_attr("imageWidth", 1024)
            camera.set_attr("imageHeight", 512)
            camera.set_attr("cameraType", "PANORAMA")
```

```python
class LabelMapping(PixelProcessor):
    def process(self, **kwargs):
        self.gen_semantic(label_arch=NYU40_Mapping)
``` -->
<h2><a class="header" href="#minervas-output-samples" id="minervas-output-samples">MINERVAS output samples</a></h2>
<!-- TBD. -->
<!-- ![semantic_samples](./../examples_figs/semantic_samples.png) -->
<p><img src="./../examples_figs/semantic_samples_nyu40.png" alt="semantic_samples" /></p>
<!-- ## Experimental Setup

In this experiment, we use 2D-3D-S [[1]](#1) as the real data. We split the images into 955 for
training, 84 for validation, and 373 for testing. Then, we
synthesize 12k panoramic images using our system. Each
panorama image corresponds to one room in scenes.
We use an SGD optimizer with an initial learning rate of
2 × 10−2 with a polynomial decay policy, momentum 0.9,
and weight decay of 10−4. We set the mini-batch size to
8. In “s + r”, each batch contains 4 images from the real
dataset and 4 from the synthetic dataset. For each strategy,
we train the whole network for 10k iterations.

## Results

We show more qualitative results of semantic segmentation in Figure 5. As can be seen, training
on the synthetic and real dataset achieves the best result.
The boundary is more clear in semantic segmentation. It
demonstrates that our synthetic data could be used to im-
prove the performance of network.

![fig_segmentation](./../examples_figs/fig_semantic.png)
<!-- ![table_layout](./../examples_figs/table_layout.png) -->
<!-- ## References
<a id="1">[1]</a> 
Iro Armeni, Sasha Sax, Amir R Zamir, and Silvio Savarese. Joint 2d-3d-semantic data for indoor scene understanding. arXiv preprint arXiv:1702.01105, 2017. -->
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../examples/layout_estimation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../examples/depth_estimation.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../examples/layout_estimation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../examples/depth_estimation.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
